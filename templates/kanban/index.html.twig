{% extends 'base.html.twig' %}

{% block title %}Suivi de candidatures
{% endblock %}

{% block body %}
	<main class="d-flex no-wrap">
		{{ include('./components/partials/sidebar.html.twig') }}

		<section class="container">
			<div class="banner">
				<div class="img">
					<img src="./Images/website/baner.jpg" alt="baniére image">
				</div>
				<h1 class="text-center">Suivi de candidatures</h1>
			</div>

			
			<div id="csrf-token-container" data-csrf-token="{{ csrf_token('update_job_status') }}"></div>

			<div class="my-5 row justify-content-center">
				{# {% for job_offer in job_offers %} #}
				<div class="col-12 col-lg-2 border-end border-start" id="dropzone1">
					<h4 class="text-center">A postuler</h4>
					{% for job_offer in job_offers %}
						{% if job_offer.status is defined and job_offer.status == constant('App\\Enum\\JobStatus::A_POSTULER') %}
							<div class="card-kanban step1" id="draggableElement_{{ job_offer.id }}" draggable="true">
								{{ job_offer.company ?? "N/A" }}
							</div>
						{% endif %}
					{% endfor %}
				</div>

				<div class="col-12 col-lg-2 border-end border-start" id="dropzone2">
					<h4 class="text-center">En attente</h4>
					{% for job_offer in job_offers %}
						{% if job_offer.status is defined and job_offer.status == constant('App\\Enum\\JobStatus::EN_ATTENTE') %}
							<div class="card-kanban step2" id="draggableElement_{{ job_offer.id }}" draggable="true">
								{{ job_offer.company ?? "N/A" }}
							</div>
						{% endif %}
					{% endfor %}
				</div>

				<div class="col-12 col-lg-2 border-end border-start" id="dropzone3">
					<h4 class="text-center">Entrevue</h4>
					{% for job_offer in job_offers %}
						{% if job_offer.status is defined and job_offer.status == constant('App\\Enum\\JobStatus::ENTREVUE') %}
							<div class="card-kanban step3" id="draggableElement_{{ job_offer.id }}" draggable="true">
								{{ job_offer.company ?? "N/A" }}
							</div>
						{% endif %}
					{% endfor %}
				</div>

				<div class="col-12 col-lg-2 border-end border-start" id="dropzone4">
					<h4 class="text-center">Refusé</h4>
					{% for job_offer in job_offers %}
						{% if job_offer.status is defined and job_offer.status == constant('App\\Enum\\JobStatus::REFUSE') %}
							<div class="card-kanban step4" id="draggableElement_{{ job_offer.id }}" draggable="true">
								{{ job_offer.company ?? "N/A" }}
							</div>
						{% endif %}
					{% endfor %}
				</div>

				<div class="col-12 col-lg-2 border-end border-start" id="dropzone5">
					<h4 class="text-center">Accepté</h4>
					{% for job_offer in job_offers %}
						{% if job_offer.status is defined and job_offer.status == constant('App\\Enum\\JobStatus::ACCEPTE') %}
							<div class="card-kanban step5" id="draggableElement_{{ job_offer.id }}" draggable="true">
								{{ job_offer.company ?? "N/A" }}
							</div>
						{% endif %}
					{% endfor %}
				</div>
			</div>
		</section>


	</main>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const csrfToken = document.getElementById('csrf-token-container').getAttribute('data-csrf-token');

    const dropzones = [
        { id: 'dropzone1', status: 'À postuler' },
        { id: 'dropzone2', status: 'En attente' },
        { id: 'dropzone3', status: 'Entretien' },
        { id: 'dropzone4', status: 'Refusé' },
        { id: 'dropzone5', status: 'Accepté' }
    ];

    function handleDragStart(event) {
        event.dataTransfer.setData('text/plain', event.target.id);
    }

    function handleDragOver(event) {
        event.preventDefault();
    }

    function handleDrop(event) {
        event.preventDefault();
        const data = event.dataTransfer.getData('text');
        const draggedElement = document.getElementById(data);
        const dropzone = event.currentTarget;
        
        dropzone.appendChild(draggedElement);

        const jobOfferId = data.split('_')[1];
        const newStatus = dropzones.find(zone => zone.id === dropzone.id).status;

        updateJobStatus(jobOfferId, newStatus);
    }

    function updateJobStatus(jobOfferId, newStatus) {
        console.log('Envoi du statut:', newStatus);
        fetch('/update-job-status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
            },
            body: JSON.stringify({
                jobOfferId: jobOfferId,
                newStatus: newStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Statut mis à jour avec succès', { jobOfferId, newStatus });
                window.location.reload(); // Rafraichir la page
            } else {
                console.error('Erreur lors de la mise à jour du statut:', data.message);
            }
        })
        .catch(error => console.error('Erreur lors de la requête:', error));
    }

    document.querySelectorAll('[draggable="true"]').forEach(element => {
        element.addEventListener('dragstart', handleDragStart);
    });

    dropzones.forEach(zone => {
        const dropzone = document.getElementById(zone.id);
        dropzone.addEventListener('dragover', handleDragOver);
        dropzone.addEventListener('drop', handleDrop);
    });
});
</script>
{% endblock %}
